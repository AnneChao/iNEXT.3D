---
title: "A Quick Introduction to iNEXT.3D via Examples"
author: "Anne Chao, K.H. Hu,"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    vignette: >
      %\VignetteIndexEntry{A Quick Introduction to iNEXT.3D via Examples}
      %\VignetteEngine{knitr::rmarkdown}
      %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "", 
                      fig.retina=2,
                      fig.align='center',
                      fig.width = 7, fig.height = 5,
                      warning = FALSE, message = FALSE)
options("width"=200)

if("gridExtra" %in% rownames(installed.packages()) == FALSE) {install.packages("gridExtra")}
# devtools::load_all(".")
library(iNEXT.3D)
library(ggplot2)
# data("beetles.abu")
```


`iNEXT.3D` (Interpolation and Extrapolation for three dimensions of biodiversity) is a sequel to [iNEXT](https://cran.r-project.org/web/packages/iNEXT/index.html) (Hsieh et al., 2016). 
Here the three dimensions (3D) of diversity includes taxonomic diversity (TD), phylogenetic diversity (PD) and functional diversity (FD). An online version "iNEXT.3D Online"
(https://chao.shinyapps.io/iNEXT_3D/) is also available for users without an R background.

A unified framework based on Hill numbers (for TD) and their generalizations (Hill-Chao numbers, for PD and FD) 
is adopted to quantify 3D. In this framework, TD quantifies the effective number of species, mean-PD (PD divided by 
tree depth) quantifies the effective number of lineages, and FD quantifies the effective number of virtual functional 
groups (or functional "species"). Thus, TD, mean-PD, and FD are all in the same units of species/lineage equivalents
and can be meaningfully compared; see Chao et al. (2021) for a review of the unified framework. 

`iNEXT.3D` also features two types of R/E sampling curves:

* Sample-size-based R/E sampling curves:\code{iNEXT.3D} computes diversity estimates for rarefied and 
extrapolated samples up to an appropriate size. This type of sampling curve plots the diversity estimates with respect to sample size.

* Coverage-based R/E sampling curves: \code{iNEXT.3D} computes diversity estimates for rarefied and 
extrapolated samples with sample completeness (as measured by sample coverage) up to an appropriate coverage. 
This type of sampling curve plots the diversity estimates with respect to sample coverage. 

`iNEXT.3D` also plots the above two types of sampling curves and a sample completeness curve by `ggiNEXT3D`. The sample completeness curve provides a bridge between these two types of curves.


## How to cite
If you publish your work based on results from iNEXT.3D package, you should make references to the following Online reference:

*	Chao, A., Henderson, P. A., Chiu, C.-H., Moyes, F., Hu, K.-H., Dornelas, M and. Magurran, A. E. (2021). Measuring temporal change in alpha diversity: a framework integrating taxonomic, phylogenetic and functional diversity and the iNEXT.3D standardization. Methods in Ecology and Evolution, 12, 1926-1940.

- Chao, A. and Hu, K.-H. (2023). The iNEXT.3D package: interpolation and extrapolation for three dimensions of biodiversity. R package available from CRAN.  


## SOFTWARE NEEDED TO RUN iNEXT.3D IN R
- Required: [R](https://cran.r-project.org/)
- Suggested: [RStudio IDE](https://www.rstudio.com/products/RStudio/#Desktop)


## HOW TO RUN iNEXT.3D:
The `iNEXT.3D` package can be downloaded from Anne Chao's [iNEXT.3D_github](https://github.com/AnneChao/iNEXT.3D) using the following commands. For a first-time installation, an additional visualization extension package (`ggplot2`) must be installed and loaded. 


```{r eval=FALSE}
## install iNEXT.3D package from CRAN
# install.packages("iNEXT.3D")  # coming soon

## install the latest version from github
install.packages('devtools')
library(devtools)
install_github('AnneChao/iNEXT.3D')

## import packages
library(iNEXT.3D)
```


There are six main functions in this package: 

- **iNEXT3D**: Computing interpolation and extrapolation with order q for three dimensions: taxonomic, phylogenetic and functional diversity at specified sample coverage or sample size.

- **ggiNEXT3D**: Visualizing the output from the function `iNEXT.3D`.

- **AO3D**: Computing empirical and asymptotic diversity with order q for three dimensions: taxonomic, phylogenetic and functional diversity.

- **ggAO3D**: Visualizing the output from the function `AO3D`.

- **estimate3D**: Computes taxonomic, phylogenetic, and functional diversity (Hill-Chao family with q = 0, 1 and 2) with a particular user-specified level of sample size or sample coverage.

- **DataInfo3D**: Provides basic data information.


## MAIN FUNCTION: iNEXT3D()

We first describe the main function `iNEXT3D()` with default arguments: 

```{r eval=FALSE}
iNEXT3D(data, diversity = 'TD', q = c(0,1,2), datatype = "abundance", 
        size = NULL, endpoint = NULL, knots = 40, nboot = 50, conf = 0.95, nT = NULL, 
        PDtree = NULL, PDreftime = NULL, PDtype = 'meanPD', 
        FDdistM, FDtype = 'AUC', FDtau = NULL)
```


The arguments of this function are briefly described below, and will be explained in more details by illustrative examples in later text. This main function computes diversity estimates of order q, the sample coverage estimates, and related statistics for K (if `knots = K`) evenly-spaced knots (sample sizes) between size 1 and the `endpoint`, where the endpoint is described below. Each knot represents a particular sample size for which diversity estimates will be calculated. By default, `endpoint` = double the reference sample size for abundance data or double the total sampling units for incidence data. For example, if `endpoint = 10`, `knot = 4`, diversity estimates will be computed for a sequence of samples with sizes (1, 4, 7, 10).  


<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>data</code></td>
<td align="left">
(a) For <code>datatype = "abundance"</code>, data can be input as a vector of species abundances (for a single assemblage), matrix/data.frame (species by assemblages), or a list of species abundance vectors. \cr
(b) For <code>datatype = "incidence_freq"</code>, data can be input as a vector of incidence frequencies (for a single assemblage), matrix/data.frame (species by assemblages), or a list of incidence frequencies; the first entry in all types of input must be the number of sampling units in each assemblage. \cr
(c) For <code>datatype = "incidence_raw"</code>, data can be input as a list of matrix/data.frame (species by sampling units); data can also be input as a matrix/data.frame by merging all sampling units across assemblages based on species identity; in this case, the number of sampling units (<code>nT</code>, see below) must be input. </td>
</tr>
<tr class="even">
<td align="center"><code>diversity</code></td>
<td align="left">selection of diversity type: <code>'TD'</code> = Taxonomic diversity, <code>'PD'</code> = Phylogenetic diversity, and <code>'FD'</code> = Functional diversity.</td>
</tr>
<tr class="odd">
<td align="center"><code>q</code></td>
<td align="left">a numerical vector specifying the diversity orders. Default is <code>c(0, 1, 2)</code>.</td>
</tr>
<tr class="even">
<td align="center"><code>datatype</code></td>
<td align="left">data type of input data: individual-based abundance data (<code>datatype = "abundance"</code>), sampling-unit-based incidence frequencies data (<code>datatype = "incidence_freq"</code>), or species by sampling-units incidence matrix (<code>datatype = "incidence_raw"</code>) with all entries being 0 (non-detection) or 1 (detection).</td>
</tr>
<tr class="odd">
<td align="center"><code>size</code></td>
<td align="left">an integer vector of sample sizes (number of individuals or sampling units) for which diversity estimates will be computed.
If <code>NULL</code>, then diversity estimates will be computed for those sample sizes determined by the specified/default <code>endpoint</code> and <code>knots</code>.</td>
</tr>
<tr class="even">
<td align="center"><code>endpoint</code></td>
<td align="left">an integer specifying the sample size that is the <code>endpoint</code> for rarefaction/extrapolation.
If NULL, then <code>endpoint</code> <code>=</code> double reference sample size.</td>
</tr>
<tr class="odd">
<td align="center"><code>knots</code></td>
<td align="left">an integer specifying the number of equally-spaced <code>knots</code> (say K, default is 40) between size 1 and the <code>endpoint</code>;each knot represents a particular sample size for which diversity estimate will be calculated.
If the <code>endpoint</code> is smaller than the reference sample size, then <code>iNEXT3D()</code> computes only the rarefaction esimates for approximately K evenly spaced <code>knots</code>. 
If the <code>endpoint</code> is larger than the reference sample size, then <code>iNEXT3D()</code> computes rarefaction estimates for approximately K/2 evenly spaced <code>knots</code> between sample size 1 and the reference sample size, and computes extrapolation estimates for approximately K/2 evenly spaced <code>knots</code> between the reference sample size and the <code>endpoint</code>.</td>
</tr>
<tr class="even">
<td align="center"><code>nboot</code></td>
<td align="left">a positive integer specifying the number of bootstrap replications when assessing sampling uncertainty and constructing confidence intervals. Enter 0 to skip the bootstrap procedures. Default is 50.</td>
</tr>
<tr class="odd">
<td align="center"><code>conf</code></td>
<td align="left">a positive number < 1 specifying the level of confidence interval. Default is 0.95.</td>
</tr>
<tr class="even">
<td align="center"><code>nT</code></td>
<td align="left">(required only when <code>datatype = "incidence_raw"</code> and input data is matrix/data.frame) a vector of nonnegative integers specifying the number of sampling units in each assemblage. If assemblage names are not specified, then assemblages are automatically named as "assemblage1", "assemblage2",..., etc. </td>
</tr>
<tr class="odd">
<td align="center"><code>PDtree</code></td>
<td align="left">(required argument only for <code>diversity = "PD"</code>), a phylogenetic tree in Newick format for all observed species in the pooled assemblage.</td>
</tr>
<tr class="even">
<td align="center"><code>PDreftime</code></td>
<td align="left">(argument only for <code>diversity = "PD"</code>), a vector of numerical values specifying reference times for PD. Default is <code>NULL</code> (i.e., the age of the root of PDtree).</td>
</tr>
<tr class="odd">
<td align="center"><code>PDtype</code></td>
<td align="left">(argument only for <code>diversity = "PD"</code>), select PD type: <code>PDtype = "PD"</code> (effective total branch length) or <code>PDtype = "meanPD"</code> (effective number of equally divergent lineages). Default is <code>"meanPD"</code>, where <code>meanPD = PD/tree depth</code>.</td>
</tr>
<tr class="even">
<td align="center"><code>FDdistM</code></td>
<td align="left">(required argument only for <code>diversity = "FD"</code>), a species pairwise distance matrix for all species in the pooled assemblage.</td>
</tr>
<tr class="odd">
<td align="center"><code>FDtype</code></td>
<td align="left">(argument only for <code>diversity = "FD"</code>), select FD type: <code>FDtype = "tau_values"</code> for FD under specified threshold values, or <code>FDtype = "AUC"</code> (area under the curve of tau-profile) for an overall FD which integrates all threshold values between zero and one. Default is <code>"AUC"</code>.</td>
</tr>
<tr class="even">
<td align="center"><code>FDtau</code></td>
<td align="left">(argument only for <code>diversity = "FD"</code> and <code>FDtype = "tau_values"</code>), a numerical vector between 0 and 1 specifying tau values (threshold levels). If <code>NULL</code> (default), then threshold is set to be the mean distance between any two individuals randomly selected from the pooled assemblage (i.e., quadratic entropy).</td>
</tr>


</tbody>
</table>


This function returns an `"iNEXT3D"` object which can be further used to make plots using the function `ggiNEXT3D()` to be described below. 

## DATA INPUT FORMAT

#### Species abundance/incidence data format

To assess diversity, information on shared/unique species and their abundances is required. Thus, species identity (or any unique identification code) must be provided in the data. Three types of species abundance/incidence data are supported:

1. Individual-based abundance data (`datatype = "abundance"`): Input data for each assemblage/site include samples species abundances in an empirical sample of n individuals ("reference sample"). When there are N assemblages, input data consist of an S by N abundance matrix, or N lists of species abundances.  

2. Sampling-unit-based incidence data: There are two kinds of input data.  
 (a) Incidence-raw data (`datatype = "incidence_raw"`): for each assemblage, input data for a reference sample consist of a species-by-sampling-unit matrix; when there are N assemblages, input data consist of N lists of matrices, and each matrix is a species-by-sampling-unit matrix. The matrix of combined assemblage is allowed, but nT must be specified (see above description).
 
 (b) Incidence-frequency data (`datatype = "incidence_freq"`): input data for each assemblage consist of species sample incidence frequencies (row sums of each incidence matrix). When there are N assemblages, input data consist of an (S + 1) by N matrix, or N lists of species incidence frequencies. The first entry of each list must be the total number of sampling units, followed by the species incidence frequencies.
  
  
The abundance data set, 'Brazil', is included in `iNEXT.3D` package. It is consist of a list with three parts: "data", "dist", and "tree". The first list ("data") of Brazil data is consists of abundance data with two habitats ("Edge" and "Interior"). The second list ("dist") is consist of distance matrix for each pair of species. And the third list ("tree") is consist of the pylogenetic tree for all species. Run the following code to view the abundance data: (Here we only show the first 15 rows for each matrix.) 

```{r eval=FALSE}
data("Brazil")
Brazil$data
```

```{r echo=FALSE}
data("Brazil")
Brazil$data[1:15,]
```


We use fish data collected from three time periods, namely "1981-1985", "1987-1991", and "2015-2019", as demo incidence data to assess diversity. The data (named 'fish') is consist of a list with three parts: "data", "tree", and "dist". The first ("data") list of fish data is consists of a list of three matrices/data.frames. The first matrix represents the species-by-subplot incidence data in "1981-1985", the second matrix represents the species-by-subplots incidence data in "1987-1991", and the thrid matrix represents the species-by-subplots incidence data in "2015-2019". The second list ("tree") is consist of consist of the pylogenetic tree for all species. And the third list ("dist") is distance matrix for each pair of species. Run the following code to view the incidence raw data: (Here we only show the first ten rows and ten columns for each matrix; there are 60 columns/subplots in each forest and each year.) 

```{r eval=FALSE}
data("fish")
fish
```

```{r echo=FALSE}
data("fish")
lapply(fish$data, function(x) x[1:10,1:10])
```


#### Phylogenetic tree format for PD
To perform PD analysis, the phylogenetic tree (in Newick format) spanned by species observed in all data must be stored. For example, the phylogenetic tree for all observed species (including species in both Edge and Interior habitats) is stored in "Brazil$tree" for demonstration purpose. A partial list of the tip labels and node labels are shown below. 

```{r}
data("Brazil")
Brazil$tree
```


#### Species pairwise distance matrix format for FD
To perform FD analysis, the species-pairwise distance matrix (Gower distance computed from species traits) for species observed in all datasets must be stored in a matrix/data.frame format. Typically, the distance between any two species is computed from species traits using the Gower distance. In our demo data, the distance matrix for all species (including species in both Edge and Interior habitats) is stored in "Brazil$dist" for demonstration purpose. Here we only show the first three rows and three columns of the distance matrix.

```{r eval=FALSE}
data("Brazil")
Brazil$dist
```

```{r echo=FALSE}
data("Brazil")
round(Brazil$dist[1:3,1:3], 4)
```


## RAREFACTION/EXTRAPOLATION VIA EXAMPLES

For this data set, the following commands display the abundance data and run the `iNEXT3D()` function for three dimensions of diversity(`TD`, `PD`, `FD`) under order `q = 0, 1, 2`. The output of function `iNEXT3D()` includes three parts: `$TDInfo` (or `$PDInfo`, `$FDInfo`) for summarizing data information; `$TDiNextEst` (or `$PDiNextEst`, `$FDiNextEst`) for showing diversity estimates along with related statistics for a series of rarefied and extrapolated samples; and `$TDAsyEst` (or `$PDAsyEst`, `$FDAsyEst`) for showing asymptotic diversity estimates along with related statistics under taxonomic diversity (or phylogenetic diversity, functional diversity).

First part of output from function `iNEXT3D` is `$TDInfo` (or `$PDInfo`, `$FDInfo`), which returns basic data information.  It can also be obtained by the function `DataInfo3D()`, which will be introduced later. Information details please refer to `DataInfo3D()`. 

```{r, echo=FALSE}
data("Brazil")

output.TD <- iNEXT3D(data = Brazil$data, diversity = "TD", q = c(0, 1, 2), 
                     datatype = "abundance", nboot = 50)

output.PD <- iNEXT3D(data = Brazil$data, diversity = "PD", q = c(0, 1, 2), 
                     datatype = "abundance", PDtree = Brazil$tree, nboot = 50)

output.FD <- iNEXT3D(data = Brazil$data, diversity = "FD", q = c(0, 1, 2), 
                     datatype = "abundance", FDdistM = Brazil$dist, FDtype = "tau_values", nboot = 50)
```


```{r eval=FALSE}
data("Brazil")
output.TD = iNEXT3D(Brazil$data, diversity = "TD", q = c(0, 1, 2), datatype = "abundance")
output.TD[1]
```

```{r echo=FALSE}
output.TD[1]
```


The required argument for performing PD analysis is PDtree. For example, the phylogenetic tree for all observed species (including species in both Edge and Interior habitats) is stored in `Brazil$tree`. Then we enter the argument `PDtree = Brazil$tree`. Two optional arguments are: PDtype and PDreftime. There are two options for PDtype: "PD" (effective total branch length) or "meanPD" (effective number of equally divergent lineages, meanPD = PD/tree depth). Default is `PDtype = "meanPD"`. PDreftime is a numerical value specifying a reference time for computing phylogenetic diversity. By default (`PDreftime = NULL`), the reference time is set to the tree depth, i.e., age of the root of the phylogenetic tree. Run the following code to perform PD analysis. Information details please refer to `DataInfo3D()`. 

```{r eval=FALSE}
data("Brazil")
output.PD = iNEXT3D(Brazil$data, diversity = "PD", q = c(0, 1, 2), 
                    datatype = "abundance", PDtree = Brazil$tree)
output.PD[1]
```

```{r echo=FALSE}
output.PD[1]
```

The required argument for performing FD analysis is FDdistM. For example, the distance matrix for all species (including species in both Edge and Interior habitats) is stored in `Brazil$dist`. Then we enter the argument FDdistM = `Brazil$dist` Three optional arguments are (1) FDtype: `FDtype = "AUC"` means FD is computed from the area under the curve of a tau-profile by integrating all plausible threshold values between zero and one; `FDtype = "tau_values"` means FD is computed under specific threshold values to be specified in the argument FD_tau. (2) FD_tau: a numerical value specifying the tau value (threshold level) that will be used to compute FD. If `FDtype = "tau_values"` and `FD_tau = NULL`, then the threshold level is set to be the mean distance between any two individuals randomly selected from the pooled data over all data (i.e., quadratic entropy). Information details please refer to `DataInfo3D()`. 

```{r eval=FALSE}
data("Brazil")
output.FD = iNEXT3D(Brazil$data, diversity = "FD", q = c(0, 1, 2), 
                    datatype = "abundance", FDdistM = Brazil$dist, FDtype = "tau_values")
output.FD[1]
```

```{r echo=FALSE}
output.FD[1]
```


Second part of output from function `iNEXT3D` is diversity estimates and related statistics computed for these 40 knots by default (for example in "Edge" assemblage, corresponding to sample sizes m = 1, 95, 189, ..., 1699, 1794, 1795, 1899, ..., 3588), which locates the reference sample size at the mid-point of the selected knots. The diversity can be based on sample-size-based and sample coverage-based. The first data frame of list `$TDiNextEst` (or `$PDiNextEst`, `$FDiNextEst`) (as shown below for 'size_based') includes the sample size (`m`), the `Method` (`Rarefaction`, `Observed`, or `Extrapolation`, depending on whether the size `m` is less than, equal to, or greater than the reference sample size), the diversity order (`Order.q`), the diversity estimate of order q (`qTD` in TD, `qPD` in PD, `qFD` in FD), the lower and upper confidence limits of diversity (`qTD.LCL` and `qTD.UCL` in TD, `qPD.LCL` and `qPD.UCL` in PD, `qFD.LCL` and `qFD.UCL` in FD) conditioning on sample size, and the sample coverage estimate (`SC`) along with the lower and upper confidence limits of sample coverage (`SC.LCL`, `SC.UCL`). These sample coverage estimates with confidence intervals are used for plotting the sample completeness curve. It is time consuming for `diversity = FD` and `FDtype = "AUC"`. If the argument `nboot` is greater than zero, then the bootstrap method is applied to obtain the confidence intervals for each diversity and sample coverage estimates. 

Here only show first six rows for each diversity:

```{r eval=FALSE}
output.TD$TDiNextEst$size_based
```

```{r, echo=FALSE}
head(output.TD$TDiNextEst$size_based)
```

```{r eval=FALSE}
output.PD$PDiNextEst$size_based
```

```{r, echo=FALSE}
head(output.PD$PDiNextEst$size_based)
```

```{r eval=FALSE}
output.FD$FDiNextEst$size_based
```

```{r, echo=FALSE}
head(output.FD$FDiNextEst$size_based)
```

The second data frame of list `$TDiNextEst` (or `$PDiNextEst`, `$FDiNextEst`) (as shown below for 'coverage_based') includes the sample coverage estimate (`SC`), the sample size (`m`), the `Method` (`Rarefaction`, `Observed`, or `Extrapolation`, depending on whether the coverage `SC` is less than, equal to, or greater than the reference sample coverage), the diversity order (`Order.q`), the diversity estimate of order q (`qTD` in TD, `qPD` in PD, `qFD` in FD), the lower and upper confidence limits of diversity (`qTD.LCL` and `qTD.UCL` in TD, `qPD.LCL` and `qPD.UCL` in PD, `qFD.LCL` and `qFD.UCL` in FD) conditioning on sample coverage estimate. 

Here only show first six rows for each diversity:

```{r, eval=FALSE}
output.TD$TDiNextEst$coverage_based
```

```{r, echo=FALSE}
head(output.TD$TDiNextEst$coverage_based)
```

```{r, eval=FALSE}
output.PD$PDiNextEst$coverage_based
```

```{r, echo=FALSE}
head(output.PD$PDiNextEst$coverage_based)
```

```{r, eval=FALSE}
output.FD$FDiNextEst$coverage_based
```

```{r, echo=FALSE}
head(output.FD$FDiNextEst$coverage_based)
```

The output `$TDAsyEst` (or `$PDAsyEst`, `$FDAsyEst`) lists the diversity labels (`Taxonomic Diversity` in TD, `Phylogenetic Diversity` in PD, `Functional Diversity` in FD), the observed diversity (`Taxonomic Observed` in TD, `Phylogenetic Observed` in PD, `Functional Observed` in FD), asymptotic diversity estimates  (`Taxonomic Estimator` in TD, `Phylogenetic Estimator` in PD, `Functional Estimator` in FD), estimated asymptotic bootstrap standard error (`s.e.`) and  confidence intervals for asymptotic diversity with q = 0, 1, and 2 (`LCL`, `UCL`). The estimated asymptotic and observed diversity can also be computed via the function `AO3D()`. The output are shown below:

```{r, eval=FALSE}
output.TD$TDAsyEst
```

```{r, echo=FALSE}
tmp = output.TD$TDAsyEst
tmp[,-(1:2)] = round(tmp[,-(1:2)], 3)
tmp
```

```{r, eval=FALSE}
output.PD$PDAsyEst
```

```{r, echo=FALSE}
tmp = output.PD$PDAsyEst
tmp[,-c(1:2,9)] = round(tmp[,-c(1:2,9)], 3)
tmp[,-(8:9)]
```

```{r, eval=FALSE}
output.FD$FDAsyEst
```

```{r, echo=FALSE}
tmp = output.FD$FDAsyEst
tmp[,-(1:2)] = round(tmp[,-(1:2)], 3)
tmp
```

The user can key in an integer sample size vector to designate the maximum sample size of R/E calculation. For species richness (order q = 0), the extrapolation method is reliable up to the double reference sample size; beyond that, the prediction bias may be large. However, for the measures of order q = 1 and 2, the extrapolation can reliably be extended to the asymptotic value (sample coverage = 1) if data are not sparse. If you choose a large number for bootstrap (`nboot`), it may take a long time to obtain the output. Following example below (don't show the output):

```{r eval=FALSE}
# set a sample size vector (m) for R/E computation
m <- c(1, 5, 20, 50, 100, 200, 400, 1000, 2000)
iNEXT3D(Brazil$data, diversity = "TD", q = 0, datatype="abundance", size = m)
```


## GRAPHIC DISPLAYS: FUNCTION ggiNEXT3D()

The function `ggiNEXT3D()`, which extends `ggplot2` with default arguments, is described as follows: 

```{r eval=FALSE}
ggiNEXT3D(output, type = 1:3, facet.var = "Assemblage", color.var = "Order.q")  
```

Here `output` is the object of `iNEXT3D()`'s output. Three types of curves are allowed for different diversity dimensions:  

(1) Sample-size-based R/E curve (`type = 1`): This curve plots diversity estimates with confidence intervals as a function of sample size.  

(2) Sample completeness curve (`type = 2`): This curve plots the sample coverage with respect to sample size. 

(3) Coverage-based R/E curve (`type = 3`): This curve plots the diversity estimates with confidence intervals as a function of sample coverage. 

The argument `facet.var = "Order.q"` or `facet.var = "Assemblage"` is used to create a separate plot for each value of the specified variable. For example, the following code displays a separate plot of the diversity order q. The `ggiNEXT3D()` function is a wrapper with package `ggplot2` to create a R/E curve in a single line of code. The figure object is of class `"ggplot"`, so can be manipulated by using the `ggplot2` tools. 

When `facet.var = "Assemblage"` in `ggiNEXT3D` function, it creates a separate plot for each assemblage and the different color lines represent each diversity order. Sample-size-based R/E curve (`type = 1`) as below:

```{r }
# Sample-size-based R/E curves, separating by "assemblage""
ggiNEXT3D(output.TD, type = 1, facet.var = "Assemblage")
```

When `facet.var = "Order.q"` in `ggiNEXT3D` function, it creates a separate plot for each diversity order and the different color lines represent each assemblage. Sample-size-based R/E curve (`type = 1`) as below:

```{r }
# Sample-size-based R/E curves, separating by "Order.q"
ggiNEXT3D(output.TD, type = 1, facet.var = "Order.q")
```


The following command return the sample completeness (sample coverage) curve (`type = 2`) in which different colors are used for the three assemblages. 

```{r}
ggiNEXT3D(output.TD, type = 2, color.var = "Assemblage")
```


The following commands return the coverage-based R/E sampling curves in which different colors are used for the three assemblages (`facet.var = "Assemblage"`) and for three diversity orders (`facet.var = "Order.q"`).

```{r}
ggiNEXT3D(output.TD, type = 3, facet.var = "Assemblage")
```

```{r}
ggiNEXT3D(output.TD, type = 3, facet.var = "Order.q")
```


### EXAMPLE for INCIDENCE-RAW DATA

Incidence raw data is allowed for three diversity dimensions. For illustration, use the Hinkley's fish data (the dataset is included in the package) at three time periods (1981-1985, 1987-1991 and 2015-2019). Here only use taxonomic diversity (TD) as demonstration below.

```{r}
output.raw <- iNEXT3D(data = fish$data, diversity = "TD",
                   q = c(0, 1, 2), datatype = "incidence_raw", nboot = 50)
ggiNEXT3D(output.raw, type = 1)
```

```{r}
ggiNEXT3D(output.raw, type = 2)
```

```{r}
ggiNEXT3D(output.raw, type = 3)
```


### EXAMPLE for INCIDENCE-FREQUENCY DATA

We transform Hinkley's fish data (incidence-raw data) to incidence-frequency data (`incidence_freq`). The first row must be the total number of sampling units, followed by the species incidence frequencies in each assemblage. Here only use taxonomic diversity (TD) for demonstration below. (Only show the first six rows of incidence frequency data)

```{r eval=FALSE}
fish.freq = cbind(c( ncol(fish$data$`1981-1985`), rowSums(fish$data$`1981-1985`) ),
                  c( ncol(fish$data$`1987-1991`), rowSums(fish$data$`1987-1991`) ),
                  c( ncol(fish$data$`2015-2019`), rowSums(fish$data$`2015-2019`) ))
rownames(fish.freq)[1] = "sample units"
colnames(fish.freq) = names(fish$data)
fish.freq
```

```{r echo=FALSE}
fish.freq = cbind(c( ncol(fish$data$`1981-1985`), rowSums(fish$data$`1981-1985`) ),
                  c( ncol(fish$data$`1987-1991`), rowSums(fish$data$`1987-1991`) ),
                  c( ncol(fish$data$`2015-2019`), rowSums(fish$data$`2015-2019`) ))
rownames(fish.freq)[1] = "sample units"
colnames(fish.freq) = names(fish$data)
head(fish.freq)
```

Note that incidence-frequency data (`datatype = "incidence_freq`) is allowed only for diversity class: `"TD"`, `"FD"`. If `"PD"` required, use incidence-raw data instead. The following commands return three R/E sampling curves for fish data. The argument `color.var =  "Order.q"` is used to display curves in different colors for diversity order.

```{r}
output.incfreq <- iNEXT3D(data = fish.freq, diversity = "TD",
                          q = c(0, 1, 2), datatype = "incidence_freq", nboot = 50)

# Sample-size-based R/E curves
ggiNEXT3D(output.incfreq, type = 1, color.var = "Order.q")
```



```{r}
# Sample completeness curves
ggiNEXT3D(output.incfreq, type = 2)
```

```{r}
# Coverage-based R/E curves
ggiNEXT3D(output.incfreq, type = 3, color.var = "Order.q")     
```


## DATA INFORMATION FUNCTION: DataInfo3D()

The function `DataInfo3D()` provides basic data information for the reference sample in each individual assemblage. The function `DataInfo3D()` with default arguments is shown below:
 
```{r eval=FALSE}
DataInfo3D(data, diversity = "TD", datatype = "abundance", 
           nT = NULL, PDtree, PDreftime = NULL, 
           FDdistM, FDtype = "AUC", FDtau = NULL) 
```

All arguments in the above function are the same as those for the main function `iNEXT3D`. Running the `DataInfo3D()` function returns basic data information including sample size, observed species richness, two sample coverage estimates (SC(n) and SC(2n)) as well as other relevant information in each of the three dimensions of diversity. We use Brazil data to demo the function for each dimension. 

```{r}
DataInfo3D(Brazil$data, diversity = 'TD', datatype = "abundance")
```

Output description:

- `Assemblage` = assemblage name. 

- `n` = number of observed individuals in the reference sample (sample size).

- `S.obs` = number of observed species in the reference sample.

- `SC(n)` = sample coverage estimate of the reference sample.

- `SC(2n)` = sample coverage estimate of twice the reference sample size.

- `f1`-`f5` = the first five species abundance frequency counts in the reference sample.

```{r}
DataInfo3D(Brazil$data, diversity = 'PD', datatype = "abundance", PDtree = Brazil$tree)
```

Information description:

- `Assemblage`, `n`, `S.obs`, `SC(n)` and `SC(2n)`: definitions are the same as in the TD output.

- `PD.obs` = the observed total branch length in the phylogenetic tree spanned by all observed species.

- `f1*`-`f2*` = the number of singletons and doubletons in the node/branch abundance set.

- `g1`-`g2` = the total branch length of those singletons/doubletons in the node/branch abundance set.

- `Reftime` = reference time for phylogenetic diversity (the age of the root of phylogenetic tree).

```{r}
DataInfo3D(Brazil$data, diversity = 'FD', datatype = "abundance", 
           FDtype = "tau_values", FDdistM = Brazil$dist)
```

Information description:

- `Assemblage`, `n`, `S.obs`, `SC(n)` and `SC(2n)`: definitions are the same as in the TD output.

- `a1*`-`a2*` = the number of singletons (`a1*`) and of doubletons (`a2*`) among the functionally indistinct set at the specified threshold level 'Tau'.

- `h1`-`h2` = the total contribution of singletons (`h1`) and of doubletons (`h2`) at the specified threshold level 'Tau'.

- `Tau` = the specified threshold level of distinctiveness. Default is dmean (the mean distance between any two individuals randomly selected from the pooled data over all datasets).

```{r}
DataInfo3D(Brazil$data, diversity = 'FD', datatype = "abundance", FDtype = "AUC", FDdistM = Brazil$dist)
```

Information description:

- `Assemblage`, `n`, `S.obs`, `SC(n)` and `SC(2n)`: definitions are the same as in TD and thus are omitted.

- `dmin` = the minimum distance among all non-diagonal elements in the distance matrix.

- `dmean` = the mean distance between any two individuals randomly selected from each assemblage.

- `dmax` = the maximum distance among all elements in the distance matrix.


## POINT ESTIMATION FUNCTION: estimate3D()

`estimate3D` is used to compute three diversity dimensions (TD, PD, FD) estimates with q = 0, 1, 2 under any specified level of sample size (when `base = "size"`) or sample coverage (when `base = "coverage"`) for either abundance data (`datatype = "abundance"`) or incidence data (`datatype = "incidence_freq"` or `"incidence_raw"`). If `level = NULL`, this function computes the diversity estimates for the minimum sample size among all samples extrapolated to double reference sizes (when `base = "size"`) or the minimum sample coverage among all samples extrapolated to double reference sizes (when `base = "coverage"`). 

```{r eval=FALSE}
estimate3D(data, diversity = "TD", q = c(0, 1, 2), datatype = "abundance", 
           base = "coverage", level = NULL, nboot = 50, conf = 0.95, 
           nT = NULL, PDtree, PDreftime = NULL, PDtype = "meanPD", 
           FDdistM, FDtype = "AUC", FDtau = NULL) 
```

All arguments in the above function are the same as those for the main function `iNEXT3D`. For example, the following command returns the 3D with a specified level of the minimum sample coverage among all samples extrapolated to double reference sizes for the Brazil data.  

```{r}
estimate3D(Brazil$data, diversity = 'TD', q = c(0,1,2), datatype = "abundance", 
           base = "coverage", level = NULL)
```

```{r}
estimate3D(Brazil$data, diversity = 'PD', q = c(0,1,2), datatype = "abundance", 
           base = "size", level = NULL, PDtree = Brazil$tree)
```

```{r}
estimate3D(Brazil$data, diversity = 'FD', q = c(0,1,2), datatype = "abundance", 
           base = "coverage", level = NULL, FDdistM = Brazil$dist, nboot = 30)
```


## ASYMPTOTIC AND OBSERVED DIVERSITY FUNCTION: AO3D

```{r, eval=FALSE}
AO3D(data, diversity = "TD", q = seq(0, 2, 0.2), datatype = "abundance",
     nboot = 50, conf = 0.95, nT = NULL, method = c("Asymptotic", "Observed"),
     PDtree, PDreftime = NULL, PDtype = "meanPD",
     FDdistM, FDtype = "AUC", FDtau = NULL
     )
```

All arguments in the above function are the same as those for the main function `iNEXT3D`. The function `AO3D()` compute three diversity dimensions (TD, PD, FD) for observed diversity and asymptotic diversity estimates with any diversity order. For example, the following commands returns observed and asymptotic taxonomic diversity ('TD') for Brazil data, along with its confidence interval at diversity order q from 0 to 2. Here only show the first ten rows.

```{r, eval=FALSE}
output1 <- AO3D(Brazil$data, diversity = 'TD', datatype = "abundance", 
                method = c("Asymptotic", "Observed"), nboot = 50, conf = 0.95)

output1
```

```{r, echo=FALSE}
output1 <- AO3D(Brazil$data, diversity = 'TD', datatype = "abundance", 
                method = c("Asymptotic", "Observed"), nboot = 50, conf = 0.95)

head(output1, 10)
```


## GRAPHIC DISPLAYS FUNCTION: ggAO3D()

```{r,eval=FALSE}
ggAO3D(output, profile = "q")
```

`ggAO3D` plots q-profile, time-profile, and tau-profile based on `ggplot2`. Here `output` is the object from the function `AO3D`, and `profile` is a profile selection versus to diversity. Default is `profile = "q"`. Note that `profile = "time"` is allowed for only when diversity = "PD" and `profile = "tau"` profile is allowed for only when `diversity = "FD"` and `FDtype = "tau_values"`.  

```{r }
# q-profile curves
ggAO3D(output1, profile = "q")
```

The argument `profile = "time"` in `ggAO3D` function creates a separate plot for each diversity order q. Therefore the different assemblages will be represented by different color lines.

```{r }
# time-profile curves, separating by "Order.q"
data(data.inc)
data <- data.inc$data
tree <- data.inc$tree
nT <- data.inc$nT

output2 <- AO3D(data, diversity = 'PD', q = c(0, 1, 2), datatype = "incidence_raw", 
                nT = nT, nboot = 50, method = c("Asymptotic", "Observed"), 
                PDtree = tree, PDreftime = seq(0.1, 82.8575, length.out = 40))

ggAO3D(output2, profile = "time")
```

The argument `profile = "tau"` in `ggAO3D` function creates a separate plot for each diversity order q. Therefore the different assemblages will be represented by different color lines.

```{r }
# tau-profile curves, separating by "Order.q"
data <- Brazil$data
distM <- Brazil$dist

output3 <- AO3D(data, diversity = 'FD', q = c(0, 1, 2), datatype = "abundance", 
                nboot = 50, method = "Observed", 
                FDtau = seq(0, 1, 0.1), FDdistM = distM, FDtype = 'tau_values')

ggAO3D(output3, profile = "tau")
```


## License
The iNEXT.3D package is licensed under the GPLv3. To help refine `iNEXT.3D`, your comments or feedback would be welcome (please send them to Anne Chao or report an issue on the iNEXT.3D github [iNEXT.3D_github](https://github.com/AnneChao/iNEXT.3D). 

## References
- Chao, A., Henderson, P. A., Chiu, C.-H., Moyes, F., Hu, K.-H., Dornelas, M and Magurran, A. E. (2021). Measuring temporal change in alpha diversity: a framework integrating taxonomic, phylogenetic and functional diversity and the iNEXT.3D standardization. Methods in Ecology and Evolution, 12, 1926-1940.

- T.C. Hsieh, K. H. Ma, and Chao, A. (2016). iNEXT: An R package for rarefaction and extrapolation of species diversity (Hill numbers). Methods in Ecology and Evolution, 7, 1451-1456.


